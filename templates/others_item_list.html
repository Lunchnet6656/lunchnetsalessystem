<!DOCTYPE html>
{% extends 'base.html' %}

{% block title %}その他の項目設定{% endblock %}

{% block content %}
{% load custom_filters %}
{% load humanize %}
<!-- jQueryおよびjQuery UIの読み込み（CDNから） -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

<style>
    .drag-handle {
        cursor: move; /* マウスカーソルを移動可能な状態に変更 */
        display: flex; /* アイコンとチェックボックスを横並びに */
        align-items: center; /* 垂直方向に中央揃え */
        height: 50px;
    }
    /* テーブル全体の幅 */
    .table {
        table-layout: fixed; /* 正しい記述方法 */
        width: 80% !important; /* テーブルの幅を80%に変更 */
    }

    .table th, .table td {
        width: 420px;
    }

    /* 1列目の幅 */
    .table th:first-child, .table td:first-child {
        width: 40px; /* 1列目の幅を固定 */
        text-align: center; /* 中央揃え */
    }
    .table th:nth-child(2), .table td:nth-child(2) {
        width: 30px; /* 2列目の幅を固定（ここで任意の幅に設定） */
        text-align: center; /* 左揃え */
    }


</style>

<div class="container mt-4">
<h1 class="mb-1">その他の項目設定</h1>
<hr class="my-4">
<form id="othersForm" method="POST">
  {% csrf_token %}
  <div class="table-responsive">
  <table class="table table-sm table-striped">
    <thead>
        <tr>
            <th></th>
            <th><input type="checkbox" id="selectAll"></th>
            <th>NO</th>
            <th>商品名</th>
            <th>単価</th>
        </tr>
    </thead>
    <tbody id="othersTableBody">
        <tr>
          {% for items in item %}
          <td class="drag-handle">
            <i class="material-icons">menu</i>
          </td>
          <td><input type="checkbox" name="selected_ids" value="{{ items.id }}"></td>
          <td><input type="text" class="others-input" name="others[{{ forloop.counter0 }}][no]" value="{{ items.no }}" style="width: 70px;"></td>
          <td><input type="text" class="others-input" name="others[{{ forloop.counter0 }}][name]" value="{{ items.name }}" style="width: 180px;"></td>
          <td><input type="text" class="others-input" name="others[{{ forloop.counter0 }}][price]" value="{{ items.price }}" style="width: 100px;"></td>
        </tr>
        {% empty %}
          <tr>
              <td colspan="5" class="text-center">データがありません</td>
          </tr>
        {% endfor %}
    </tbody>
  </table>
  </div> 
      <button type="button" class="btn btn-success" id="addRowButton">新規追加</button>
      <button type="submit" name="delete" class="btn btn-danger" id="deleteButton">削除</button>
      <button type="submit" class="btn btn-primary">上書き保存</button>
</form>
</div>
<script>

  document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('input[name="selected_ids"]');
      checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
      });
  });
  document.addEventListener('DOMContentLoaded', function() {
      // jQuery UIのSortableをテーブルに適用
      $("#othersTableBody").sortable({
          handle: '.drag-handle', // ドラッグハンドルとして三本線を指定
          update: function(event, ui) {
              // 行の順番が変更されたときにNOフィールドを更新
              $('#othersTableBody tr').each(function(index) {
                  $(this).find('input[name^="others["][name$="[no]"]').val(index + 1); // 行の順番に基づいてNOフィールドを更新
              });
          }
      });

      // 新規行の追加
      document.getElementById('addRowButton').addEventListener('click', function() {
          let tableBody = document.getElementById('othersTableBody');
          let rowCount = tableBody.rows.length; // 現在の行数からインデックスを決定
          let newRow = document.createElement('tr');
          newRow.innerHTML = `
              <td class="drag-handle">
                <span class="drag-icon"></span>
                <input type="checkbox" name="selected_ids" value="">
              </td>
              <td><input type="checkbox" name="selected_ids" value=""></td> <!-- チェックボックスの列 -->
              <td><input type="text" name="others[${rowCount}][no]" value=""></td>
              <td><input type="text" name="others[${rowCount}][name]" value=""></td>
              <td><input type="text" name="others[${rowCount}][price]" value=""></td>
          `;
          tableBody.appendChild(newRow);
      });

      // 削除ボタンの確認ダイアログ
      document.getElementById('deleteButton').addEventListener('click', function() {
        if (confirm('選択した項目を削除しますか？')) {
            // フォームを送信
            document.getElementById('othersForm').submit();
        }
      });
});
</script>


{% endblock %}
